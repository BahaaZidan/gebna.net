- [x] Implement result reference substitution so method arguments like `#mailboxCreationId` are resolved before invoking handlers (`apps/backend/src/jmap.routes.ts:78-149`) to reach baseline RFC 8621 compliance.
- [x] Enforce per-method capability requirements instead of only rejecting unknown capabilities, returning `unknownCapability` when `using` omits `urn:ietf:params:jmap:mail`, `submission`, etc. (`apps/backend/src/jmap.routes.ts:60-141`).
- [x] Replace the one-shot `/jmap/event-source` response with a long-lived SSE stream that emits incremental state diffs from `change_log` (`apps/backend/src/jmap.routes.ts:211-247`).
- [x] Rework `normalizeFilter` so `Email/query` can combine multiple filter properties simultaneously instead of discarding everything after the first key (`apps/backend/src/lib/jmap/method-handlers/email-query.ts:134-247`).
- [x] Push `Email/query` pagination/sorting into SQL with `LIMIT/OFFSET` and only compute totals when requested to avoid materializing the entire mailbox on every call (`apps/backend/src/lib/jmap/method-handlers/email-query.ts:249-284`).
- [x] Persist filtered query states so `Email/queryChanges` can honor a `filter` rather than returning `unsupportedFilter` for anything but the default view (`apps/backend/src/lib/jmap/method-handlers/email-query-changes.ts:22-74`).
- [x] Sort the `emailIds` returned by `Thread/get` (e.g., newest first) to satisfy the ordering guarantee in RFC 8621 (`apps/backend/src/lib/jmap/method-handlers/thread-get.ts:24-55`).
- [x] Expand `Mailbox/query` to accept filter/sort/position arguments and correctly report `canCalculateChanges` instead of always returning the full list (`apps/backend/src/lib/jmap/method-handlers/mailbox-query.ts:15-42`).
- [x] Return accurate per-mailbox rights and thread counts (total/unread) in `Mailbox/get` rather than hard-coding permissive booleans for every mailbox (`apps/backend/src/lib/jmap/method-handlers/mailbox-get.ts:13-83`).
- [x] Store normalized text/html bodies at ingest time (e.g., in `apps/backend/src/lib/mail/ingest.ts`) and have `Email/get` serve `bodyValues` from the database instead of reparsing each MIME blob from R2 (`apps/backend/src/lib/jmap/method-handlers/email-get.ts:320-464`).
- [x] Stream blobs from R2 (or issue byte-range reads) inside `Blob/get` so we never buffer entire multi-megabyte objects just to return a slice or digest (`apps/backend/src/lib/jmap/method-handlers/blob.ts:90-230`).
- [x] Add per-IP/user rate limiting (and logging) to `/auth/login` and `/auth/register` to mitigate brute-force attempts (`apps/backend/src/auth.routes.ts:18-86`).
- [x] Verify the incoming SNS `TopicArn` matches the configured SES topic before updating submission status, alerting on mismatches (`apps/backend/src/ses-webhook.routes.ts:52-205`).
- [ ] Hide destroyed `Email` rows everywhere by filtering `accountMessageTable.isDeleted = 0` in `Email/get`, `Email/query`, `Thread/*`, and any other handler that currently reads from `account_message` without that predicate (`apps/backend/src/lib/jmap/method-handlers/email-get.ts:69-101`, `apps/backend/src/lib/jmap/method-handlers/email-query.ts:69-452`).
- [ ] Make `Email/get` honor `JMAP_CORE.maxObjectsInGet`, preserve caller order, and return `mailboxIds` as the `{ mailboxId: true }` object defined in RFC 8621 instead of the current string array (`apps/backend/src/lib/jmap/method-handlers/email-get.ts:61-287`).
- [ ] Expose `messageId`, `inReplyTo`, `references`, and a proper `attachments` array (with `blobId`, type, size, cid, disposition) in `Email/get` by reading from `messageTable`/`attachmentTable` (`apps/backend/src/lib/jmap/method-handlers/email-get.ts`, `apps/backend/src/db/schema.ts:140-237`).
- [ ] Persist real MIME part metadata (hierarchy + `blobId`) during ingest and use it to return spec-compliant `bodyStructure`/`attachments` instead of the current flattened `buildBodyStructure` output (`apps/backend/src/lib/mail/ingest.ts:153-214`, `apps/backend/src/lib/jmap/method-handlers/email-get.ts:308-360`).
- [ ] Serve `bodyValues` for every text/html part (and allow values larger than the 256 KiB ingest cache) by streaming from the raw MIME in R2 when `maxBodyValueBytes` demands it (`apps/backend/src/lib/jmap/method-handlers/email-get.ts:321-412`).
- [ ] Support the `header:Name:asText/asRaw/asAddresses` suffixes in `Email/get` instead of treating every `header:*` request as a plain string lookup (`apps/backend/src/lib/jmap/method-handlers/email-get.ts:297-306`).
- [ ] Broaden the `Email/query` filter engine to cover the rest of RFC 8621 (`body`, `hasAttachment`, `attachmentName`, `attachmentType`, etc.) and make `text` searches look at addresses + stored body text, not just `subject`/`snippet` (`apps/backend/src/lib/jmap/method-handlers/email-query.ts:90-550`).
- [ ] When a filter has been persisted, return `canCalculateChanges: true` and periodically purge stale rows from `jmap_query_state` so the table doesn’t grow without bound (`apps/backend/src/lib/jmap/method-handlers/email-query.ts:101-176`).
- [ ] Teach `Email/queryChanges` to examine the `updated` ids from `changeLog` so it can emit `added`/`removed` entries for moves/keyword changes instead of only acting on creations and destroys (`apps/backend/src/lib/jmap/method-handlers/email-query-changes.ts:83-127`).
- [ ] Extend `getChanges`/`*/changes` to honor the optional `upToId` argument and include the `updatedProperties` array (or `null`) in every response, clamping `maxChanges` for `EmailSubmission/changes` to the capability limit while doing so (`apps/backend/src/lib/jmap/utils.ts:34-130`, `apps/backend/src/lib/jmap/method-handlers/email-submission-changes.ts:20-34`).
- [ ] Enforce the session capability limits: check `JMAP_CORE.maxCallsInRequest`/`maxSizeRequest` in `handleJmap`, clamp every `/get` to `maxObjectsInGet`, and reject `Email/`, `EmailImport`, and `EmailSubmission/set` requests that exceed `maxObjectsInSet` (`apps/backend/src/jmap.routes.ts:228-289`, `apps/backend/src/lib/jmap/method-handlers/email-set.ts`, `apps/backend/src/lib/jmap/method-handlers/email-import.ts`, `apps/backend/src/lib/jmap/method-handlers/email-submission-set.ts`).
- [ ] Query `EmailSubmission/get` by the requested ids instead of loading the entire table, and keep the response list in the same order the client asked for (`apps/backend/src/lib/jmap/method-handlers/email-submission-get.ts:22-55`).
- [ ] Lock down `EmailSubmission` envelopes so overrides can only use the selected identity’s address/domain and fail fast if the referenced `Email` (or its blob) has been deleted before delivery (`apps/backend/src/lib/jmap/method-handlers/email-submission-set.ts:425-505`, `apps/backend/src/lib/outbound/submission-queue.ts:50-103`).
- [ ] Allow `onSuccessUpdateEmail`/`onSuccessDestroyEmail` to accept real email ids (not just `#creationId` references) when wiring implicit `Email/set` calls (`apps/backend/src/lib/jmap/method-handlers/email-submission-set.ts:690-748`).
- [ ] Emit `recordUpdate` rows whenever the submission queue or SES webhook mutates delivery status so `EmailSubmission/changes` subscribers learn about `sending/sent/failed` transitions (`apps/backend/src/lib/outbound/submission-queue.ts:106-200`, `apps/backend/src/ses-webhook.routes.ts:166-205`).
- [ ] When `processSingleSubmission` can’t load the target `Email`/blob (e.g., the user deleted it), mark that submission failed with a descriptive `deliveryStatus` instead of leaving it stuck in `pending` (`apps/backend/src/lib/outbound/submission-queue.ts:50-105`).
- [ ] Reclaim storage/quota when an `Email` is destroyed: once no other `account_message` references a canonical message, drop its `account_blob` rows and delete the orphaned `message`/`attachment`/`blob` records so `handleBlobUploadHttp`’s quota math reflects reality (`apps/backend/src/lib/jmap/method-handlers/email-set.ts:880-919`, `apps/backend/src/jmap.routes.ts:320-364`).
- [ ] Persist per-blob metadata (type/name) at upload time and include those fields in `Blob/get`, and expand `Blob/lookup` `typeNames` beyond `"Email"` so clients can resolve `EmailBodyValue` references as mandated by RFC 8621 (`apps/backend/src/lib/jmap/method-handlers/blob.ts:16-149`, `apps/backend/src/jmap.routes.ts:292-375`).
- [ ] Extend structured `Email/set` create to handle attachments referencing uploaded blobs (and fold them into the generated MIME) instead of limiting drafts to `textBody`/`htmlBody` only (`apps/backend/src/lib/jmap/method-handlers/email-set.ts:403-575`).
